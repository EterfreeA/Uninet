# 状态机
状态衍生多功能状态，多功能状态派生状态机，同时状态机也是状态，由此推出无限状态机原型。  
![UML类图](image/UML.png)

状态机并未直接继承状态，而是继承由状态派生的多功能状态，至于多功能状态的虚函数，其目的是配合状态机的接口。

类模板|说明
-|-
State|状态抽象类模板，定义处理事件的接口。
MultiState|多功能状态抽象类模板，作为状态树的叶子节点。
StateMachine|状态机类模板，作为状态树的非叶子节点。
Transition|过渡类模板。过渡是抽象事物，当处理输入和转换状态之时，在不同状态之间传递信息。

状态机既能够添加状态，也能够添加状态机。如果向状态机添加状态机，就形成层次状态机。如果把状态机和状态视作节点，层次状态机就是多叉状态树。  
![多叉状态树](image/Polystate%20Tree.png)  
凡是涉及状态树的序列化与反序列化，都采用深度优先的遍历方式。上图状态树的遍历顺序为S-A-A1-A2-B-C-C1-C2。

## 构建与销毁
### 构建方式
状态机支持三种构建方式，分别是外部单独添加方式、外部批量添加方式和内部动态添加方式。

方式|方法|说明
-|-|-
外部单独添加方式|AddState|向指定路径的状态机节点添加状态。
外部批量添加方式|Distribute|序列化状态树为向量，并且作为参数调用状态机接口，再反序列化，分发状态节点以构造状态机。
内部动态添加方式|Handle/Convert|在执行处理输入方法Handle，或者执行强制转换方法Convert之时，由前状态创建后状态，存至过渡对象并且返回交给状态机。

### 销毁方式
状态机与状态是聚合关系，在销毁状态机之前，需要回收状态实例，正确释放资源。状态机支持两种销毁方式，分别是单独移除方式和批量收集方式。

方式|方法|说明
-|-|-
单独移除方式|GetState/RemoveState|可以通过方法GetState获取状态实例，也可以通过RemoveState移除非当前状态。
批量收集方式|Collect|收集所有状态实例。

## 备份与还原
状态机提供备份与还原方法，本质是序列化与反序列化根节点至最下层有效节点的路径，即状态ID向量。  
**特别注意**：除非能够保证在还原之时有效状态存在，否则不应采用内部动态添加方式。

## 状态转换
状态机支持三种转换方式，分别是输入驱动方式、指定目标方式和强制转换方式。
* **输入驱动方式**：在执行处理输入方法Handle之时，由当前状态指定后续状态，存至过渡对象并且返回，交由状态机转换。
* **指定目标方式**：深度优先遍历状态树，持续转换状态直到目标状态为止，或者未找到目标状态，直到最后状态退出之后，状态机设为无效状态。
  此方式对应于方法Update，提供有序和无序两种遍历方法，如果状态树无序，则需要提供所有节点的序列化向量，指定访问节点的顺序。
* **强制转换方式**：在非输入驱动之时，由前状态向上访问状态机，主动转换为后状态，对应于方法Convert。
  强制转换方式仅限于同一状态机的状态转换，跨状态机节点的状态转换可以交由上下的状态机节点自行实现。

### 输入驱动
当状态机发生输入事件之时，传递给当前状态处理，处理结束返回过渡对象，若过渡对象持有后续状态，则向状态机添加后续状态。状态机先触发当前状态的退出事件，若过渡对象指定后续状态，再触发后续状态的进入事件，否则状态机设为无效状态。  
![输入驱动](image/Input%20Drive.png)

## 项目结构
源码只含头文件，放于文件夹include。

文件|说明
-|-
[State.hpp](include/State.hpp)|定义状态抽象类模板State和多功能状态抽象类模板MultiState。
[StateMachine.hpp](include/StateMachine.hpp)|定义状态机类模板StateMachine。
[Transition.hpp](include/Transition.hpp)|定义过渡类模板Transition。

示例代码文件放于文件夹example。

文件|说明
-|-
[Owner.hpp](example/Owner.hpp)|定义属主类和各状态类。
[Owner.cpp](example/Owner.cpp)|实现属主类和各状态类。
[test.cpp](example/test.cpp)|测试代码。

## 作者
name：许聪  
mailbox：2592419242@qq.com  
CSDN：https://blog.csdn.net/xucongyoushan  
gitee：https://gitee.com/solifree  
github：https://github.com/xucongandxuchong
